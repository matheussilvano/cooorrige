<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Redefinir Senha | Cooorrige</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="favicon.png" />
  <link rel="stylesheet" href="styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap"
    rel="stylesheet"
  />
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HRHF1XJTSD"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-HRHF1XJTSD');
  </script>
  <style>
    body {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      text-align: center;
    }
    main {
      max-width: 500px;
    }
    #reset-message {
      font-size: 0.9rem;
      margin-top: 1rem;
      margin-bottom: 1.5rem;
    }
    #reset-message.success {
      color: var(--success);
    }
    #reset-message.error {
      color: var(--danger);
    }
    .auth-card {
        background: var(--surface);
        border-radius: var(--radius-lg);
        padding: 1.6rem 1.7rem;
        box-shadow: var(--shadow-soft);
        border: 1px solid var(--border-subtle);
        width: 100%;
    }
  </style>
</head>
<body>
  <main>
    <div class="logo-area" style="align-items: center; margin-bottom: 1.5rem;">
      <div class="logo-row">
        <img src="logo.png" alt="Mooose" class="mooose-logo" />
        <span class="logo-word">
          <span class="logo-m">M</span>
          <span class="logo-o logo-o-1">O</span>
          <span class="logo-o logo-o-2">O</span>
          <span class="logo-o logo-o-3">O</span>
          <span class="logo-rest">SE</span>
        </span>
      </div>
      <span class="logo-subtitle">
        <span class="logo-cooorrige">Cooorrige</span> · módulo
        <span class="badge-edu">Mooose Edu</span>
      </span>
    </div>

    <div class="auth-card" id="reset-card">
        <h2>Crie sua nova senha</h2>
        <p id="reset-message">Preencha os campos abaixo.</p>

        <form id="form-reset-password">
            <label>
              Nova senha
              <input type="password" name="new_password" required minlength="4" />
            </label>
            <label>
              Confirme a nova senha
              <input type="password" name="confirm_password" required minlength="4" />
            </label>
            <button type="submit" class="primary-btn full">
              Salvar nova senha
            </button>
        </form>
    </div>

    <div class="auth-card hidden" id="success-card">
        <h2>Sucesso!</h2>
        <p id="success-message" class="form-message success" style="font-size: 1rem;">
            Sua senha foi atualizada.
        </p>
        <a href="index.html" class="primary-btn" style="margin-top: 1rem;">Ir para o Login</a>
    </div>

  </main>

  <script src="app.js"></script>
  
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const msgEl = document.getElementById("reset-message");
      const form = document.getElementById("form-reset-password");
      const resetCard = document.getElementById("reset-card");
      const successCard = document.getElementById("success-card");
      const successMsg = document.getElementById("success-message");

      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');

      if (!token) {
        msgEl.textContent = "Erro: Token de redefinição não encontrado na URL.";
        msgEl.classList.add("error");
        form.classList.add("hidden");
        return;
      }

      // API_BASE vem do app.js
      if (typeof API_BASE === 'undefined') {
        msgEl.textContent = "Erro: Falha ao carregar configuração da API.";
        msgEl.classList.add("error");
        form.classList.add("hidden");
        return;
      }
      
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        msgEl.textContent = "";
        msgEl.className = "form-message";
        
        const formData = new FormData(form);
        const newPassword = formData.get("new_password");
        const confirmPassword = formData.get("confirm_password");
        
        if (newPassword !== confirmPassword) {
            msgEl.textContent = "As senhas não coincidem.";
            msgEl.classList.add("error");
            return;
        }
        
        const payload = {
            token: token,
            new_password: newPassword
        };
        
        const btn = form.querySelector('button[type="submit"]');
        const originalLabel = btn ? btn.textContent : "";
        if (btn) {
            btn.disabled = true;
            btn.classList.add("button-loading");
            btn.textContent = "Salvando...";
        }

        try {
            const res = await fetch(`${API_BASE}/auth/reset-password`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            });

            const data = await res.json();

            if (!res.ok) {
                throw new Error(data.detail || "Falha ao redefinir a senha. O token pode ter expirado.");
            }
            
            // Sucesso!
            successMsg.textContent = data.message || "Senha atualizada com sucesso!";
            resetCard.classList.add("hidden");
            successCard.classList.remove("hidden");

        } catch (err) {
            console.error(err);
            msgEl.textContent = `Erro: ${err.message}`;
            msgEl.classList.add("error");
        } finally {
            if (btn) {
                btn.disabled = false;
                btn.classList.remove("button-loading");
                btn.textContent = originalLabel;
            }
        }
      });
    });
  </script>
</body>
</html>